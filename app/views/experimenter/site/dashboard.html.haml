- content_for :title do
  Traveler

- content_for :head do
  = stylesheet_link_tag 'experimenter'
  %link(href="/javascripts/openlayers/theme/default/google.css" rel="stylesheet" type="text/css")
  %script(src = "http://maps.google.com/maps/api/js?sensor=false")
  
- content_for :content do
  :javascript
    var map;
    var previousMapCenter;
    var travelFixSelectControl;
    
    $(document).ready(function() {
      // BASE MAP
      map = new OpenLayers.Map('map');
      map.addControl(new OpenLayers.Control.LayerSwitcher());
      var ghyb = new OpenLayers.Layer.Google(
          "Google Hybrid",
          {type: google.maps.MapTypeId.HYBRID, numZoomLevels: 20}
      );
      var gphy = new OpenLayers.Layer.Google(
          "Google Physical",
          {type: google.maps.MapTypeId.TERRAIN}
      );
      var gmap = new OpenLayers.Layer.Google(
          "Google Streets", // the default
          {numZoomLevels: 20}
      );
      var gsat = new OpenLayers.Layer.Google(
          "Google Satellite",
          {type: google.maps.MapTypeId.SATELLITE, numZoomLevels: 22}
      );
      map.addLayers([ghyb, gphy, gmap, gsat]);
      // TRAVEL FIXES
      var travelFixStyleMap = new OpenLayers.StyleMap({
          "default": new OpenLayers.Style({
              pointRadius: 5,
              fillColor: "#66ccff",
              strokeColor: "#3399ff",
              strokeWidth: 2,
              graphicZIndex: 1
          }),
          "select": new OpenLayers.Style({
              fillColor: "#ffcc66",
              strokeColor: "#ff9933",
              graphicZIndex: 2
          })
      });
      var travelFixLayer = new OpenLayers.Layer.Vector("Travel Fixes", {styleMap: travelFixStyleMap});
      map.addLayer(travelFixLayer);
      travelFixSelectControl = new OpenLayers.Control.SelectFeature(travelFixLayer, {
        hover: true,
        eventListeners: {
          featurehighlighted: function(event) {
            $('input#travel-fix-' + event.feature.attributes.travelFixId).parent().removeClass('selected').addClass('highlighted');
          },
          featureunhighlighted: function(event) {
            $('input#travel-fix-' + event.feature.attributes.travelFixId).parent().removeClass('highlighted').addClass('selected');            
          }
        }
      });
      map.addControl(travelFixSelectControl);
      travelFixSelectControl.activate();
      
      // Google.v3 uses EPSG:900913 as projection, so we have to
      // transform our coordinates
      map.setCenter(new OpenLayers.LonLat(-122.26620197296143,37.869467010881124).transform(
          new OpenLayers.Projection("EPSG:4326"),
          map.getProjectionObject()
      ), 10);
      previousMapCenter = map.getCenter();
      
      // DATA
      window.Participant = Backbone.Model.extend({
        name: 'participant',
        initialize: function() {
          this.display = false;
          this.travelFixes = new TravelFixes;
          this.travelFixes.url = '/api/participants/' + this.id + '/travel_fixes.json';
          this.travelFixes.bind('refresh', function() {
            travelFixes.add(this.models);
          });
        },
      });
      window.TravelFix = Backbone.Model.extend({
        name: 'travel_fix',
        marker: null
      });
      
      window.Participants = Backbone.Collection.extend({
        name: 'participants',
        model: Participant,
        url: '/api/participants.json'
      });
      window.TravelFixes = Backbone.Collection.extend({
        name: 'travel_fixes',
        model: TravelFix,
        //url: '/api/travel_fixes.json'
      });
      
      window.travelFixes = new TravelFixes;
      window.participants = new Participants;
      
      window.ParticipantItemView = Backbone.View.extend({
        tagName: 'li',
        className: 'participant-item',
        template: _.template('<input type="checkbox" id="participant-<%= id %>" class="checkbox"/> <%= first_name + " " + last_name %>'),
        events: {
          "click .checkbox" : "toggle"
        },
        render: function() {
          $(this.el).html(this.template(this.model.toJSON()));
          return this;
        },
        toggle: function() {
          if (this.model.display == false) {
            this.model.display = true;
            this.model.travelFixes.fetch();
            // will be added to travelFixes by this.travelFixes.bind('refresh', function() {...
            $(this.el).addClass('selected');
          }
          else {
            this.model.display = false;
            travelFixes.remove(this.model.travelFixes.models);
            $(this.el).removeClass('selected highlighted');
          }
        },
      });
      
      
      window.TravelFixItemView = Backbone.View.extend({
        tagName: 'li',
        className: 'travel-fix-item',
        template: _.template('<input type="checkbox" id="travel-fix-<%= id %>" class="checkbox"/> <%= new Date(created_at).strftime("%a, %b %d %Y %I:%M %p") %>'),
        events: {
          "click .checkbox" : "toggle",
          "mouseover"       : "highlightMarker",
          "mouseout"        : "unhighlighMarker"
        },
        render: function() {
          $(this.el).html(this.template(this.model.toJSON()));
          return this;
        },
        toggle: function() {
          if (!this.model.marker) {
            var marker = new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(this.model.attributes.longitude,this.model.attributes.latitude).transform(
                new OpenLayers.Projection("EPSG:4326"),
                map.getProjectionObject()
            ), { travelFixId: this.model.id });
            travelFixLayer.addFeatures(marker);
            previousMapCenter = map.getCenter();
            map.panTo(new OpenLayers.LonLat(this.model.attributes.longitude,this.model.attributes.latitude).transform(
                new OpenLayers.Projection("EPSG:4326"),
                map.getProjectionObject()
            ));
            this.model.marker = marker;
            $(this.el).addClass('selected');
          }
          else {
            travelFixLayer.removeFeatures(this.model.marker);
            this.model.marker = null;
            $(this.el).removeClass('selected highlighted');
          }
        },
        highlightMarker: function() {
          if (this.model.marker) {
            $(this.el).removeClass('selected').addClass('highlighted')
            
            $('#participant-' + this.model.attributes.participant_id).parent().removeClass('selected').addClass('highlighted');
            
            travelFixSelectControl.select(this.model.marker);
            
            previousMapCenter = map.getCenter();
            map.panTo(new OpenLayers.LonLat(this.model.attributes.longitude,this.model.attributes.latitude).transform(
                new OpenLayers.Projection("EPSG:4326"),
                map.getProjectionObject()
            ));
          }
        },
        unhighlighMarker: function() {
          if (this.model.marker) {
            $(this.el).removeClass('selected').addClass('highlighted');
            $('#participant-' + this.model.attributes.participant_id).parent().addClass('selected').removeClass('highlighted');
            travelFixSelectControl.unselect(this.model.marker);
          }
          map.panTo(previousMapCenter);
        }
      });
      
      window.ParticipantListView = Backbone.View.extend({
        id: 'participant-list',
        initialize: function() {
          _.bindAll(this, 'addAll');
          participants.bind('refresh', this.addAll);
          participants.refresh(#{@participants.to_json.html_safe});
        },
        addOne: function(participant) {
          var view = new ParticipantItemView({model: participant});
          this.$("#participant-list").append(view.render().el);
        },
        addAll: function() {
          participants.each(this.addOne);
        }
      });
      
      window.TravelFixListView = Backbone.View.extend({
        id: 'travel-fix-list',
        initialize: function() {
          _.bindAll(this, 'addAll');
          travelFixes.bind('refresh', this.addAll);
          travelFixes.bind('add', this.addAll);
          travelFixes.bind('remove', this.addAll);
          //travelFixes.refresh(#{@travel_fixes.to_json.html_safe});
        },
        addOne: function(travelFix) {
          var view = new TravelFixItemView({model: travelFix});
          this.$("#travel-fix-list").append(view.render().el);
        },
        addAll: function() {
          $('#travel-fix-list').empty();
          travelFixes.each(this.addOne);
        }
      });
      
      window.participantListView = new ParticipantListView;
      window.travelFixListView = new TravelFixListView;
      
      // CONTROLS
      $('#select-all-travel-fixes').click(function(event) {
        $('#travel-fix-list :checkbox').each(function(index, element) {
          if ($(element).attr('checked') != true) $(element).trigger('click');
        });
      });
    });
  
  #container
    #map
    
    #participant-column
      %h1 Participants
      %ul#participant-list
  
    #travel-fix-column
      %h1 Travel Fixes
      %a#select-all-travel-fixes(href='#') show all
      %ul#travel-fix-list
  
    #trip-column
      %h1 Trips
  
    #activity-column
      %h1 Activities
  
= render :file => 'experimenter/_base'